<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" type="image/png" href="../Vetores/icone.png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Área do Cliente</title>
</head>

<body>
    <header>
        <nav>
            <ul class="menu-top">
                <li>
                    <img class="logo"
                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/logo_vacsense%20SEM%20FUNDO.png?raw=true"
                        alt="Logo">
                </li>
                <li>
                    <a href="dashboard.html">
                        <img class="icon"
                            src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_grafico.svg?raw=true"
                            alt="Dashboard">
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="./Analytics.html">
                        <img class="icon"
                            src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_analytics.svg?raw=true"
                            alt="Analytics">
                        Analytics
                    </a>
                </li>
                <li>
                    <a href="cadastrar_usuarios.html">
                        <img class="icon"
                            src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_usuario.svg?raw=true"
                            alt="Usuários">
                        Usuários
                    </a>
                </li>
            </ul>
            <ul class="menu-bottom">
                <li>
                    <a href="#">
                        <img class="icon"
                            src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_config.svg?raw=true"
                            alt="Configurações">
                        Configurações
                    </a>
                </li>
                <li>
                    <a href="../Monitor Health + VacSense/Login.html">
                        <img class="icon"
                            src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_sair.svg?raw=true"
                            alt="Sair">
                        Sair
                    </a>
                </li>
            </ul>
        </nav>
    </header>
    <!-- <main> tag HTML que indica o conteúdo principal de uma página -->
    <main class="container">
        <div class="dash">
            <header>
                <div>
                    <h1>Dashboard</h1>
                    <select name="local" id="" onchange="window.location.href=this.value">
                        <option value="" disabled selected>Selecione o Ambiente</option>
                        <option selected value="dashboard.html">Freezer 1</option>
                        <option value="dashboardCongelante.html">Freezer 2</option>
                        <option value="dashboardDerretendo.html">Freezer 3</option>
                    </select>
                </div>
                <small class="date" id="dataAtual">17/04/2023 - 12:06:23</small>
            </header>
            <div class="graphs">
                <div class="first-graph">
                    <div class="pricipal-content">
                        <div class="indicators">
                            <div id="indicator_current_temp" class="indicator success">
                                <div class="information">
                                    <small>
                                        Temperatura (°C)
                                        <span>Atual</span>
                                    </small>
                                    <span id="current_temp" class="measurement">3,8°</span>
                                </div>
                                <img class="indicator-icon"
                                    src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_termometro.svg?raw=true"
                                    alt="Termometro">
                            </div>
                            <div id="indicator_avg_temp" class="indicator warning">
                                <div class="information">
                                    <small>
                                        Temperatura (°C)
                                        <span>Média</span>
                                    </small>
                                    <span id="avg" class="measurement">6,0°</span>
                                </div>
                                <img class="indicator-icon"
                                    src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_termometro.svg?raw=true"
                                    alt="Termometro">
                            </div>
                        </div>
                    </div>
                    <div class="chart">
                        <h3 class="label">Temperatura (°C)</h3>
                        <canvas style="position: relative; height: 50vh; width: 30vw;" id="first_chart"></canvas>
                    </div>
                </div>
                <div class="second-graph">
                    <div class="chart">
                        <h3 class="label">Temperatura X Abertura</h3>
                        <canvas style="position: relative; height: 50vh; width: 30vw;" id="second_chart"></canvas>
                    </div>
                    <div class="pricipal-content">
                        <div class="indicators">
                            <div class="indicator">
                                <div class="information-status">
                                    <img class="indicator-icon-status"
                                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/status_fechado.svg?raw=true"
                                        alt="Status fechado">
                                    <small>
                                        <span>Status Fechado</span>
                                    </small>
                                </div>
                            </div>
                            <div class="indicator normal">
                                <div class="information">
                                    <small>
                                        Total de
                                        <span>Aberturas (Dia)</span>
                                    </small>
                                    <span class="measurement" id="measurement">120</span>
                                </div>
                                <img class="indicator-icon"
                                    src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_floco_neve.svg?raw=true"
                                    alt="Termometro">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="profile">
            <img class="photo" src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/foto_perfil.svg?raw=true"
                alt="Foto de Perfil">
            <div class="description">
                <h3 class="profile-name">Olá, Thaisa</h3>
                <small>Administrador</small>
            </div>
            <hr class="line">
            <div class="notification">
                <span class="notification-text">Notificações</span>
                <img class="icon"
                    src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_notifica%C3%A7%C3%A3o.svg?raw=true"
                    alt="">
            </div>
            <div class="alerts">
                <div class="alert success">
                    <div class="content">
                        <small>
                            <span>Alerta</span>
                            Freezer 1 está na faixa Ideal
                        </small>
                    </div>
                    <img class="icon"
                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_alerta.svg?raw=true"
                        alt="Alerta Ideal">
                </div>
                <div class="alert danger">
                    <div class="content">
                        <small>
                            <span>Alerta</span>
                            Freezer 3 está na faixa emergência
                        </small>
                    </div>
                    <img class="icon"
                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_alerta.svg?raw=true"
                        alt="Alerta Emergência">
                </div>
                <div class="alert warning">
                    <div class="content">
                        <small>
                            <span>Alerta</span>
                            Freezer 3 está na faixa quente
                        </small>
                    </div>
                    <img class="icon"
                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_alerta.svg?raw=true"
                        alt="Alerta Quente">
                </div>
                <div class="alert freezing">
                    <div class="content">
                        <small>
                            <span>Alerta</span>
                            Freezer 2 está na faixa congelante
                        </small>
                    </div>
                    <img class="icon"
                        src="https://github.com/Monitor-Health/Vetores_Dash/blob/main/icone_alerta.svg?raw=true"
                        alt="Alerta Congelante">
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

</html>
<script>
    const data = new Date()
    const dia = String(data.getDate()).padStart(2, '0')
    const mes = String(data.getMonth() + 1).padStart(2, '0')
    const ano = data.getFullYear()
    const hora = String(data.getHours()).padStart(2, '0')
    const minutos = String(data.getMinutes()).padStart(2, '0')
    const segundos = String(data.getSeconds()).padStart(2, '0')
    dataAtual.innerHTML = `${dia}/${mes}/${ano} - ${hora}:${minutos}:${segundos}`

    async function atualizarDashboard() {
        const resposta = await fetch('/medidas/ultimas');
        const dados = await resposta.json();
        var totalAberturas = 0;
        var soma = 0;
        var temperaturas = [];
        dados.forEach(dado => {
            soma += dado.valor;
            if (dado.fkSensor == 2) {
                if(dado.valor == 1){
                    totalAberturas++;
                }
            } else {
                temperaturas.push(dado.valor);
            }
        });
        var media = soma / dados.length;
        if (media >= 8 || media <= 2) {
            indicator_avg_temp.classList.remove("warning");
            indicator_avg_temp.classList.add("danger");
        } else {
            indicator_avg_temp.classList.remove("danger");
            indicator_avg_temp.classList.remove("warning");
            indicator_avg_temp.classList.add("success");
        }
        measurement.innerHTML = totalAberturas;
        console.log(temperaturas);
        current_temp.innerHTML = temperaturas[temperaturas.length - 1].toFixed(2);
        avg.innerHTML = media.toFixed(2);
        setTimeout(atualizarDashboard, 1000);
        
    }

    window.addEventListener("DOMContentLoaded", async () => {
        const resposta = await fetch('/medidas/ultimas');
        const dados = await resposta.json();
        createFirstChart(dados);
        createSecondChart(dados);
        setTimeout(atualizarDashboard, 1000);
    });

    function createFirstChart(values) {
        var times = [];
        values.forEach(d => {
            if(d.fkSensor == 1){
                times.push(parseDate(new Date(d.dt_hora)));
            }
        })
        var temperatures = [];
        values.forEach(d => {
            if (d.fkSensor == 1) {
                temperatures.push(d.valor);
            }
        })

        const labels = times;
        const data = {
            labels: labels,
            datasets: [{
                label: 'Temperatura °C',
                backgroundColor: 'rgb(77,77,77)',
                borderColor: 'rgb(77,77,77)',
                data: temperatures
            }]
        }
        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                scales: {
                    y: {
                        suggestedMin: 0,
                        suggestedMax: 10
                    },
                    x: {
                        suggestedMax: 10
                    }

                },
                plugins: {
                    title: {
                        text: "Temperatura °C"


                    },
                    legend: {
                        labels: {
                            font: {
                                family: "Montserrat",
                                weight: "bold"
                            }
                        }
                    }
                }
            }
        }
        new Chart(
            document.getElementById('first_chart'),
            config
        )
    }

    function createSecondChart(values) {
        var times = [];
        values.forEach(d => {
            if(d.fkSensor == 1){
                times.push(parseDate(new Date(d.dt_hora)));
            }
        })
        var temperatures = [];
        var isPresent = [];
        values.forEach(d => {
            if (d.fkSensor == 1) {
                temperatures.push(d.valor);
            } else {
                isPresent.push(d.valor);
            }
        })

        const labels2 = times;
        const data2 = {
            labels: labels2,
            datasets: [{
                label: 'Temperatura °C',
                backgroundColor: 'rgb(77,77,77)',
                borderColor: 'rgb(77,77,77)',
                data: temperatures,
                yAxisID: 'Temperatura',
                type: 'line',
                tension: 0.4
            },
            {
                label: 'Abertura',
                backgroundColor: 'rgb(224,224,224)',
                borderColor: 'rgb(224,224,224)',
                data: isPresent,
                yAxisID: 'Y',
                type: 'bar'
            }
            ]

        }
        const config2 = {
            data: data2,
            options: {
                responsive: true,
                scales: {
                    Y: {
                        type: 'linear',
                        position: 'left'
                    },
                    Temperatura: {
                        beginAtZero: true,
                        suggestedMax: 10,
                        type: 'linear',
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            callback: function (value, index, values) {
                                return `${value} °C `
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        text: "Temperatura °C"
                    },
                    legend: {
                        labels: {
                            font: {
                                family: "Montserrat",
                                weight: "bold"
                            }
                        }
                    }
                }
            }
        }

        new Chart(
            document.getElementById('second_chart'),
            config2
        )
    }

    function parseDate(data) {
        const dia = String(data.getDate()).padStart(2, '0')
        const mes = String(data.getMonth() + 1).padStart(2, '0')
        const ano = data.getFullYear()
        const hora = String(data.getHours()).padStart(2, '0')
        const minutos = String(data.getMinutes()).padStart(2, '0')
        const segundos = String(data.getSeconds()).padStart(2, '0')
        dataAtual.innerHTML = `${dia}/${mes}/${ano} - ${hora}:${minutos}:${segundos}`
        return `${hora}:${minutos}:${segundos}`;
    }
</script>